/*
 * GPS HIZ VE MESAFE ÖLÇÜM SİSTEMİ
 * Bluetooth (HC-05) + LCD (16x2 I2C)
 * 
 * Proje: Telefon GPS verisini Bluetooth ile alıp LCD'de gösterme
 * Tarih: Şubat 2026
 */

#include <SoftwareSerial.h>
#include <LiquidCrystal_I2C.h>

// ==================== PIN TANIMLARI ====================
#define BT_RX 10  // Arduino'nun RX pini → HC-05 TX'e
#define BT_TX 11  // Arduino'nun TX pini → HC-05 RX'e

// ==================== NESNE TANIMLARI ====================
SoftwareSerial bluetooth(BT_RX, BT_TX);
LiquidCrystal_I2C lcd(0x27, 16, 2); // Adres: 0x27 veya 0x3F (I2C scanner ile bulun)

// ==================== GLOBAL DEĞİŞKENLER ====================
String gelenVeri = "";
float hiz = 0.0;
float mesafe = 0.0;
float enlem = 0.0;   // Latitude
float boylam = 0.0;  // Longitude
bool bluetoothBagli = false;
unsigned long sonVeriMillis = 0;
int testAdim = 0;    // Test senaryosu adım sayacı

// ==================== SETUP ====================
void setup() {
  // Seri port başlat (Debug için)
  Serial.begin(9600);
  Serial.println("=== GPS Hiz ve Mesafe Sistemi ===");
  Serial.println("Bluetooth baglantisi bekleniyor...");
  
  // Bluetooth başlat
  bluetooth.begin(9600); // HC-05 default baud rate
  
  // LCD başlat
  lcd.init();
  lcd.backlight();
  lcd.clear();
  
  // Başlangıç mesajı
  baslatmaMesaji();
  
  delay(2000);
  lcd.clear();
}

// ==================== LOOP ====================
void loop() {
  // 1. Bluetooth'tan veri oku
  bluetoothOku();
  
  // 2. LCD'yi güncelle
  lcdGuncelle();
  
  // 3. Bağlantı durumunu kontrol et
  baglantiKontrol();
  
  delay(100); // CPU yükünü azalt
}

// ==================== FONKSİYONLAR ====================

/**
 * Başlangıç mesajını LCD'de gösterir
 */
void baslatmaMesaji() {
  lcd.setCursor(0, 0);
  lcd.print("  GPS SISTEMI   ");
  lcd.setCursor(0, 1);
  lcd.print(" Baslatiliyor...");
}

/**
 * Bluetooth'tan gelen verileri okur ve işler
 */
void bluetoothOku() {
  while (bluetooth.available()) {
    char karakter = bluetooth.read();
    
    // Newline karakteri gelirse veri tamamlanmış demektir
    if (karakter == '\n' || karakter == '\r') {
      if (gelenVeri.length() > 0) {
        // Debug: Gelen veriyi göster
        Serial.print("Gelen Veri: ");
        Serial.println(gelenVeri);
        
        // Test senaryosu kontrolü
        if (gelenVeri.equalsIgnoreCase("TEST")) {
          testSenaryosuBaslat();
        } else {
          // Veriyi ayrıştır
          veriAyristir(gelenVeri);
        }

        // Son veri zamanını güncelle
        sonVeriMillis = millis();
        
        // Buffer'ı temizle
        gelenVeri = "";
        
        bluetoothBagli = true;
      }
    } else {
      // Karakteri buffer'a ekle
      gelenVeri += karakter;
    }
  }
}

/**
 * Gelen veriyi ayrıştırır
 * Format: SPEED:45.50,DIST:1.32,LAT:41.0082,LON:28.9784
 */
void veriAyristir(String veri) {
  veri.trim();

  // "SPEED:", ",DIST:", ",LAT:", ",LON:" etiketlerini bul
  int speedIndex = veri.indexOf("SPEED:");
  int distIndex = veri.indexOf(",DIST:");
  int latIndex = veri.indexOf(",LAT:");
  int lonIndex = veri.indexOf(",LON:");
  
  if (speedIndex != -1 && distIndex != -1) {
    // Hız değerini al
    String hizStr = veri.substring(speedIndex + 6, distIndex);
    hiz = hizStr.toFloat();
    
    // Mesafe değerini al (LAT varsa ona kadar, yoksa sona kadar)
    String mesafeStr;
    if (latIndex != -1) {
      mesafeStr = veri.substring(distIndex + 6, latIndex);
    } else {
      mesafeStr = veri.substring(distIndex + 6);
    }
    mesafe = mesafeStr.toFloat();
    
    // Koordinatları al (varsa)
    if (latIndex != -1 && lonIndex != -1) {
      String enlemStr = veri.substring(latIndex + 5, lonIndex);
      enlem = enlemStr.toFloat();
      
      String boylamStr = veri.substring(lonIndex + 5);
      boylam = boylamStr.toFloat();
    }
    
    // Debug: Ayrıştırılan değerleri göster
    Serial.print("Ayrıştırıldı → Hız: ");
    Serial.print(hiz, 1);
    Serial.print(" km/h | Mesafe: ");
    Serial.print(mesafe, 2);
    Serial.print(" km");
    if (latIndex != -1) {
      Serial.print(" | Enlem: ");
      Serial.print(enlem, 6);
      Serial.print(" | Boylam: ");
      Serial.print(boylam, 6);
    }
    Serial.println();
    return;
  }

  // Alternatif formatlar: SPEED=..,DIST=.. veya S=..,D=..
  speedIndex = veri.indexOf("SPEED=");
  distIndex = veri.indexOf(",DIST=");
  if (speedIndex != -1 && distIndex != -1) {
    hiz = veri.substring(speedIndex + 6, distIndex).toFloat();
    mesafe = veri.substring(distIndex + 6).toFloat();
    return;
  }

  speedIndex = veri.indexOf("S=");
  distIndex = veri.indexOf(",D=");
  if (speedIndex != -1 && distIndex != -1) {
    hiz = veri.substring(speedIndex + 2, distIndex).toFloat();
    mesafe = veri.substring(distIndex + 3).toFloat();
    return;
  }

  // Basit format: 45.5;1.32
  if (veri.indexOf(';') != -1) {
    veriAyristir_Basit(veri);
    return;
  }

  Serial.println("HATA: Veri formatı hatalı! Ornek: SPEED:45.50,DIST:1.32");
}

/**
 * LCD ekranı günceller
 */
void lcdGuncelle() {
  if (bluetoothBagli) {
    // İlk satır: Hız
    lcd.setCursor(0, 0);
    lcd.print("Hiz:");
    
    // Hız değerini sağa hizalı göster
    if (hiz < 10) {
      lcd.print("  ");
    } else if (hiz < 100) {
      lcd.print(" ");
    }
    lcd.print(hiz, 1);
    lcd.print(" km/h ");
    
    // İkinci satır: Mesafe
    lcd.setCursor(0, 1);
    lcd.print("Mesafe: ");
    lcd.print(mesafe, 2);
    lcd.print(" km  ");
  }
}

/**
 * Bluetooth bağlantı durumunu kontrol eder
 */
void baglantiKontrol() {
  unsigned long simdikiZaman = millis();
  
  // 5 saniyedir veri gelmiyorsa bağlantı kesilmiş sayılır
  if (bluetoothBagli && (simdikiZaman - sonVeriMillis > 5000)) {
    bluetoothBagli = false;
    
    // Bağlantı kesildi ekranı - son bilgiler
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Baglanti Kesildi");
    lcd.setCursor(0, 1);
    lcd.print("H:");
    lcd.print(hiz, 1);
    lcd.print(" M:");
    lcd.print(mesafe, 2);
    
    Serial.println("UYARI: Bluetooth bağlantısı kesildi!");
    Serial.print("Son Hız: ");
    Serial.print(hiz, 1);
    Serial.print(" km/h | Son Mesafe: ");
    Serial.print(mesafe, 2);
    Serial.println(" km");
    if (enlem != 0.0 || boylam != 0.0) {
      Serial.print("Son Konum: ");
      Serial.print(enlem, 6);
      Serial.print(", ");
      Serial.println(boylam, 6);
    }
  }
}

// ==================== TEST SENARYOSU ====================

/**
 * Test senaryosu başlatır - sıralı GPS verileri gönderir
 * Bluetooth terminalinden "TEST" yazarak başlatın
 */
void testSenaryosuBaslat() {
  Serial.println("\n=== TEST SENARYOSU BAŞLADI ===");
  Serial.println("10 saniyelik GPS simülasyonu...");
  
  // Test verileri: İstanbul Taksim'den başlayarak hareket eden bir araç simülasyonu
  // Format: SPEED:hiz,DIST:mesafe,LAT:enlem,LON:boylam
  String testVerileri[] = {
    "SPEED:0.00,DIST:0.00,LAT:41.036758,LON:28.985033",     // Duruş - Taksim
    "SPEED:15.50,DIST:0.04,LAT:41.037012,LON:28.985234",    // Yavaş başlangıç
    "SPEED:32.80,DIST:0.12,LAT:41.037456,LON:28.985678",    // Hızlanma
    "SPEED:45.20,DIST:0.28,LAT:41.038123,LON:28.986245",    // Normal hız
    "SPEED:52.00,DIST:0.51,LAT:41.038934,LON:28.987012",    // Hızlı
    "SPEED:48.70,DIST:0.78,LAT:41.039678,LON:28.987834",    // Yavaşlama
    "SPEED:35.40,DIST:1.02,LAT:41.040234,LON:28.988456",    // Trafik
    "SPEED:25.10,DIST:1.18,LAT:41.040612,LON:28.988912",    // Yavaşlama
    "SPEED:12.30,DIST:1.28,LAT:41.040834,LON:28.989234",    // Durma yakın
    "SPEED:0.00,DIST:1.32,LAT:41.041002,LON:28.989456"      // Duruş - hedef
  };
  
  int testSayisi = 10;
  
  // Bağlantıyı aktif yap
  bluetoothBagli = true;
  
  for (int i = 0; i < testSayisi; i++) {
    Serial.print("Test ");
    Serial.print(i + 1);
    Serial.print("/");
    Serial.print(testSayisi);
    Serial.print(": ");
    Serial.println(testVerileri[i]);
    
    // Veriyi işle
    veriAyristir(testVerileri[i]);
    
    // Bağlantı zamanını güncelle (timeout olmasın)
    sonVeriMillis = millis();
    
    // LCD güncelle
    lcd.clear();
    lcdGuncelle();
    
    // 1 saniye bekle (gerçek GPS güncellemesi gibi)
    delay(1000);
  }
  
  Serial.println("=== TEST TAMAMLANDI ===");
  Serial.println("Normal moda dönülüyor...\n");
}

// ==================== ALTERNATİF VERİ AYRIŞTIRMA ====================

/**
 * Alternatif ayrıştırma yöntemi (daha basit format için)
 * Format: 45.5;1.32
 */
void veriAyristir_Basit(String veri) {
  int noktaliVirguIndex = veri.indexOf(';');
  
  if (noktaliVirguIndex != -1) {
    hiz = veri.substring(0, noktaliVirguIndex).toFloat();
    mesafe = veri.substring(noktaliVirguIndex + 1).toFloat();
  }
}

/**
 * JSON formatı için ayrıştırma
 * Format: {"speed":45.5,"dist":1.32}
 * Not: ArduinoJson kütüphanesi gerektirir
 */
/*
#include <ArduinoJson.h>

void veriAyristir_JSON(String veri) {
  StaticJsonDocument<200> doc;
  DeserializationError error = deserializeJson(doc, veri);
  
  if (!error) {
    hiz = doc["speed"];
    mesafe = doc["dist"];
  } else {
    Serial.println("JSON parse hatası!");
  }
}
*/
